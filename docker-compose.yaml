version: '3.8'

# Сети
networks:
  agent-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Сервисы
services:
  # Redis - кэш состояний агента
  redis:
    image: redis:7.2-alpine
    container_name: agent-redis
    restart: unless-stopped
    networks:
      - agent-network
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./logs/redis:/var/log/redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-} --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # Qdrant - векторная база данных
  qdrant:
    image: qdrant/qdrant:latest
    container_name: agent-qdrant
    restart: unless-stopped
    networks:
      - agent-network
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
      - ./logs/qdrant:/qdrant/log
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Сервис агента (FastAPI)
  agent-service:
    build:
      context: ./agent_service
      dockerfile: Dockerfile
      args:
        - PYTHON_VERSION=3.11
    container_name: agent-service
    restart: unless-stopped
    networks:
      - agent-network
    ports:
      - "8000:8000"
    volumes:
      - ./agent-service:/app
      - ./logs/agent:/app/logs
      - ./data:/app/data:ro
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: >
      sh -c "
        echo 'Waiting for Redis and Qdrant...' &&
        sleep 10 &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers ${WORKERS:-2}
      "

#  # Telegram бот
#  tg-bot:
#    build:
#      context: ./tg-bot-service
#      dockerfile: Dockerfile
#    container_name: tg-bot-service
#    restart: unless-stopped
#    networks:
#      - agent-network
#    volumes:
#      - ./tg-bot-service:/app
#      - ./logs/bot:/app/logs
#    depends_on:
#      agent-service:
#        condition: service_healthy
#    environment:
#      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
#      - AGENT_SERVICE_URL=http://agent-service:8000
#      - BOT_ADMIN_IDS=${BOT_ADMIN_IDS:-}
#      - LOG_LEVEL=${LOG_LEVEL:-INFO}
#      - DEBUG=${DEBUG:-false}
#      - WEBHOOK_URL=${WEBHOOK_URL:-}
#      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
#    command: >
#      sh -c "
#        echo 'Waiting for agent service...' &&
#        sleep 15 &&
#        python -m app.main
#      "
    # Для использования webhook вместо long polling раскомментируйте:
    # ports:
    #   - "8443:8443"


# Тома для постоянного хранения данных
volumes:
  redis_data:
    driver: local
    driver_opts:
      type: none
      device: ../redis_data/redis
      o: bind
  qdrant_data:
    driver: local
    driver_opts:
      type: none
      device: ../qdrant_data/qdrant
      o: bind