version: '3.8'

# Сети
networks:
  agent-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Сервисы
services:
  # Redis - кэш состояний агента
  redis:
    image: redis:7.2-alpine
    container_name: agent-redis
    restart: unless-stopped
    networks:
      - agent-network
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # Qdrant - векторная база данных
  qdrant:
    image: qdrant/qdrant:latest
    container_name: agent-qdrant
    restart: unless-stopped
    networks:
      - agent-network
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
      - ./logs/qdrant:/qdrant/log
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO

  # Сервис агента (FastAPI)
  agent-service:
    build:
      context: ./agent_service
      dockerfile: Dockerfile
      args:
        - PYTHON_VERSION=3.13
    container_name: agent-service
    restart: unless-stopped
    networks:
      - agent-network
    ports:
      - "8000:8000"

#  # Telegram бот
#  tg-bot:
#    build:
#      context: ./tg-bot-service
#      dockerfile: Dockerfile
#    container_name: tg-bot-service
#    restart: unless-stopped
#    networks:
#      - agent-network
#    volumes:
#      - ./tg-bot-service:/app
#      - ./logs/bot:/app/logs
#    depends_on:
#      agent-service:
#        condition: service_healthy
#    environment:
#      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
#      - AGENT_SERVICE_URL=http://agent-service:8000
#      - BOT_ADMIN_IDS=${BOT_ADMIN_IDS:-}
#      - LOG_LEVEL=${LOG_LEVEL:-INFO}
#      - DEBUG=${DEBUG:-false}
#      - WEBHOOK_URL=${WEBHOOK_URL:-}
#      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
#    command: >
#      sh -c "
#        echo 'Waiting for agent service...' &&
#        sleep 15 &&
#        python -m app.main
#      "
    # Для использования webhook вместо long polling раскомментируйте:
    # ports:
    #   - "8443:8443"


# Тома для постоянного хранения данных
volumes:
  redis_data:
  qdrant_data: